<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Block 的为什么会有循环引用 · 红纸</title><meta name="description" content="Block 的为什么会有循环引用 - HongZhi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.zhz.io/atom.xml" title="红纸"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nianran" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Block 的为什么会有循环引用</h1><div class="post-info">Mar 15, 2017</div><div class="post-content"><h2 id="这次分享要解决的问题"><a href="#这次分享要解决的问题" class="headerlink" title="这次分享要解决的问题"></a>这次分享要解决的问题</h2><p>Block 为什么会引起循环引用</p>
<h2 id="本次实验"><a href="#本次实验" class="headerlink" title="本次实验"></a>本次实验</h2><ul>
<li>平台信息</li>
<li>Apple LLVM version 8.0.0 (clang-800.0.42.1)</li>
<li>Target: x86_64-apple-darwin16.4.0</li>
<li>Thread model: posix</li>
<li>InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</li>
<li>MRC</li>
</ul>
<a id="more"></a>
<h2 id="为什么会出现循环引用"><a href="#为什么会出现循环引用" class="headerlink" title="为什么会出现循环引用"></a>为什么会出现循环引用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">     +-----------+           +-----------+</div><div class="line">     | instance  |           |   Block   |</div><div class="line">---&gt; |           | --------&gt; |           |</div><div class="line">     | retain 2  | &lt;-------- | retain 1  |</div><div class="line">     |           |           |           |</div><div class="line">     +-----------+           +-----------+</div></pre></td></tr></table></figure>
<p>如上图所示。两个实例相互持有。<br>1.如果要释放instance，那么要先释放Block。<br>2.如果要释放block，那么要先释放instance。<br>条件1和2不能够同时满足，那么两个都不会被进行释放，这就是所谓的循环引用。</p>
<h2 id="Block的实现"><a href="#Block的实现" class="headerlink" title="Block的实现"></a>Block的实现</h2><p>工具Clang（GCC的替代品）,编译源码生成可执行文件。<br><em>–rewrite-objc</em>将OC的.m文件转换为cpp文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -rewrite-objc Test.m</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        // insert code here...</div><div class="line">        NSLog(@&quot;Hello, World!&quot;);</div><div class="line">        ^&#123;</div><div class="line">            NSLog(@&quot;Hello Block&quot;);</div><div class="line">        &#125;();</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用Clang命令对源码进行重写。提取关键代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">struct __block_impl &#123;</div><div class="line">  void *isa;</div><div class="line">  int Flags;</div><div class="line">  int Reserved;</div><div class="line">  void *FuncPtr;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __main_block_desc_0* Desc;</div><div class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_dz_d6n3371d4951v8wz6yx9tbwc0000gn_T_main_cd25fe_mi_1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</div><div class="line"></div><div class="line"></div><div class="line">((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA))();</div></pre></td></tr></table></figure></p>
<p>从中我们可以得到些什么关键的数据<br>一个基础block结构体<strong>_block_imp</strong><br>一个静态C函数<strong>_main_block_func_0</strong>（命名方式：当前类的函数名+block+func+当前Block在文件中Block的序列号。）<br>一个block的结构体<strong>_main_block_impl_0</strong>(命名方式：当前类的函数名+block+impl+当前Block在文件中Block的序列号。)<br>一个block的解释体<strong>main_block_desc_0</strong>(命名方式：当前类的函数名+desc+impl+当前Block在文件中Block的序列号。)</p>
<p>简化得到基础的Block结构体模型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">struct Block_literal_1 &#123;</div><div class="line">    void *isa;//ARC:__NSMallocBlock__/__NSGlobalBlock__ MRC:__NSMallocBlock__/__NSStackBlock__/__NSGlobalBlock__</div><div class="line">    int flags;//copy到堆时候用的标识</div><div class="line">    int reserved;//保留变量</div><div class="line">    void (*invoke)(void *, ...);//函数指针，实际Block的函数调用地址，类似于实例方法的IMP</div><div class="line">    struct Block_descriptor_1 *descriptor;//Block描述信息</div><div class="line">&#125;;</div><div class="line">//非本节关注点。有兴趣自由研究。</div><div class="line">struct Block_descriptor_1 &#123;</div><div class="line">    unsigned long int reserved;//保留变量</div><div class="line">    unsigned long int size;//Block在内存中的大小</div><div class="line">    void (*copy)(void *dst, void *src);//copy到堆上使用的方法</div><div class="line">    void (*dispose)(void *);//执行Release操作</div><div class="line">    const char *signature;//函数签名</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>NSMallocBlock</strong>:堆区</li>
<li><strong>NSStackBlock</strong> :栈区</li>
<li><strong>NSGlobalBlock</strong>:Data/Text区</li>
</ul>
<h2 id="Block参数自动捕获机制"><a href="#Block参数自动捕获机制" class="headerlink" title="Block参数自动捕获机制"></a>Block参数自动捕获机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        // insert code here...</div><div class="line">        NSLog(@&quot;Hello, World!&quot;);</div><div class="line">        NSString *a = nil;</div><div class="line">        ^&#123;</div><div class="line">            NSLog(@&quot;%@&quot;,a);</div><div class="line">            NSLog(@&quot;Hello Block&quot;);</div><div class="line">        &#125;();</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简化上述描述，最后得到结果Block为如下值，从中我们可以看到Block的结构体实例会持有a。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">struct Block_literal_1 &#123;</div><div class="line">    void *isa;</div><div class="line">    int flags;</div><div class="line">    int reserved;</div><div class="line">    void (*invoke)(void *, ...);</div><div class="line">    struct Block_descriptor_1 *descriptor;</div><div class="line">    </div><div class="line">    NSString *a;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>看完了C的这些实现我们来看OC的代码,测试代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@interface Test ()</div><div class="line">@property (nonatomic, strong) NSString *a;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Test</div><div class="line">- (void)test&#123;</div><div class="line">    ^&#123;</div><div class="line">        NSLog(@&quot;%@&quot;,self.a);</div><div class="line">        NSLog(@&quot;Hello Block&quot;);</div><div class="line">    &#125;();</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>简化得到Block如下,从中我们看到其实Block是持有self的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">struct Block_literal_1 &#123;</div><div class="line">    void *isa;</div><div class="line">    int flags;</div><div class="line">    int reserved;</div><div class="line">    void (*invoke)(void *, ...);</div><div class="line">    struct Block_descriptor_1 *descriptor;</div><div class="line">    </div><div class="line">    Test *self;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>所以Block是通过持有self实例来调用a的成员变量<br>简化版调用a成员变量的实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static void __Test__test_block_func_0(struct __Test__test_block_impl_0 *__cself) &#123;</div><div class="line">  Test *self = __cself-&gt;self; // bound by copy</div><div class="line">        NSLog((NSString *)objc_msgSend)((id)self, sel_registerName(&quot;a&quot;));</div><div class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_dz_d6n3371d4951v8wz6yx9tbwc0000gn_T_Test_92b943_mi_1);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2><p>retain cycle问题的根源在于Block和obj可能会互相强引用，互相retain对方，这样就导致了retain cycle，最后这个Block和obj就变成了孤岛，谁也释放不了谁。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];</div><div class="line">[request setCompletionBlock:^&#123;</div><div class="line">  NSString* string = [request responseString];</div><div class="line">&#125;];</div><div class="line"></div><div class="line">     +-----------+           +-----------+</div><div class="line">     | request   |           |   Block   |</div><div class="line">---&gt; |           | --------&gt; |           |</div><div class="line">     | retain 2  | &lt;-------- | retain 1  |</div><div class="line">     |           |           |           |</div><div class="line">     +-----------+           +-----------+</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> __block ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];</div><div class="line"> [request setCompletionBlock:^&#123;</div><div class="line">   NSString* string = [request responseString];</div><div class="line"> &#125;];</div><div class="line">     +-----------+           +-----------+</div><div class="line">     | request   |           |   Block   |</div><div class="line">----&gt;|           | --------&gt; |           |</div><div class="line">     | retain 1  | &lt; - - - - | retain 1  |</div><div class="line">     |           |   weak    |           |</div><div class="line">     +-----------+           +-----------+</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ClassA* objA = [[[ClassA alloc] init] autorelease];</div><div class="line">objA.myBlock = ^&#123;</div><div class="line">  [self doSomething];</div><div class="line">&#125;;</div><div class="line">self.objA = objA;</div><div class="line"></div><div class="line">+-----------+           +-----------+           +-----------+</div><div class="line">|   self    |           |   objA    |           |   Block   |</div><div class="line">|           | --------&gt; |           | --------&gt; |           |</div><div class="line">| retain 2  |           | retain 1  |           | retain 1  |</div><div class="line">|           |           |           |           |           |</div><div class="line">+-----------+           +-----------+           +-----------+</div><div class="line">     ^                                                |</div><div class="line">     |                                                |</div><div class="line">     +------------------------------------------------+</div></pre></td></tr></table></figure>
<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><p>__block和__weak实现原理（有兴趣的自行了解）<br>关键代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">struct __Block_byref_weakSelf_0 &#123;</div><div class="line">  void *__isa;</div><div class="line">__Block_byref_weakSelf_0 *__forwarding;</div><div class="line"> int __flags;</div><div class="line"> int __size;</div><div class="line"> void (*__Block_byref_id_object_copy)(void*, void*);</div><div class="line"> void (*__Block_byref_id_object_dispose)(void*);</div><div class="line"> typeof (self) weakSelf;</div><div class="line">&#125;;</div><div class="line">struct __Test__test_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __Test__test_block_desc_0* Desc;</div><div class="line">  __Block_byref_weakSelf_0 *weakSelf; // by ref</div><div class="line">  __Block_byref_string_1 *string; // by ref</div><div class="line">  __Test__test_block_impl_0(void *fp, struct __Test__test_block_desc_0 *desc, __Block_byref_weakSelf_0 *_weakSelf, __Block_byref_string_1 *_string, int flags=0) : weakSelf(_weakSelf-&gt;__forwarding), string(_string-&gt;__forwarding) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __Test__test_block_dispose_0(struct __Test__test_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line">static void __Test__test_block_dispose_0(struct __Test__test_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;weakSelf, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div></pre></td></tr></table></figure></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://clang.llvm.org/docs/Block-ABI-Apple.html" target="_blank" rel="noopener">LLVM 中 block 实现源码</a><br><a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="noopener">谈Objective-C block的实现</a><br><a href="http://tanqisen.github.io/blog/2013/04/19/gcd-block-cycle-retain/" target="_blank" rel="noopener">文中实际使用举例</a><br><a href="https://github.com/deput/NSInvocation-Block/blob/master/NSInvocation%2BBlock.m" target="_blank" rel="noopener">NSInvocation&lt;-&gt;block</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/05/Advanced-Apple-Debugging阅读笔记Part1/" class="prev">上一篇</a><a href="/2016/12/31/我的2016年总结/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhz';
var disqus_identifier = '2017/03/15/Block-的为什么会有循环引用/';
var disqus_title = 'Block 的为什么会有循环引用';
var disqus_url = 'http://www.zhz.io/2017/03/15/Block-的为什么会有循环引用/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhz.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2018 <a href="http://www.zhz.io">HongZhi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-82278125-1",'auto');ga('send','pageview');</script></body></html>